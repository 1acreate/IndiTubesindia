<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IndiTubes</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#e53935"/>
  <style>
    body{margin:0;font-family:sans-serif;background:#f2f3f5;color:#333;}
    header{background:#e53935;color:#fff;padding:1rem;display:flex;justify-content:space-between;align-items:center;}
    .wallet{font-weight:bold;}
    section{padding:1rem;display:none;}
    .active{display:block;}
    input,button{margin:0.5rem 0;padding:0.7rem;border-radius:5px;border:1px solid #ccc;width:100%;box-sizing:border-box;}
    button{cursor:pointer;}
    nav{position:fixed;bottom:0;width:100%;display:flex;border-top:1px solid #ccc;background:#fff;}
    nav button{flex:1;padding:0.8rem;border:none;background:#fafafa;font-size:0.9rem;}
    .card{background:#fff;margin:1rem 0;padding:1rem;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);}
    video{width:100%;border-radius:8px;}
    .top-info{display:flex;align-items:center;gap:10px;margin:0.5rem 0;}
    .top-info img{width:35px;height:35px;border-radius:50%;object-fit:cover;}
    .likes button, .share-btn, .connect-btn{background:#e0e0e0;border:none;border-radius:5px;margin-right:5px;padding:3px 8px;font-size:0.8rem;cursor:pointer;}
    .share-btn{background:#42a5f5;color:#fff;}
    .connect-btn{background:yellow;}
    .connect-btn.active{background:green;color:#fff;}
    .timer{margin-top:5px;font-size:0.9rem;color:#e68a00;}
    .views{font-size:0.8rem;color:#666;margin-left:auto;}
  </style>
</head>
<body>
  <header>
    <div>üé• IndiTubes</div>
    <div class="wallet">Wallet: ‚Çπ<span id="wallet">0</span></div>
  </header>

  <div id="loginBox" style="padding:1rem;">
    <h3>Login / Signup</h3>
    <input id="uName" placeholder="Username"/><br/>
    <input id="uPass" type="password" placeholder="Password"/><br/>
    <input id="chImgFile" type="file" accept="image/*"/><br/>
    <button onclick="doLogin()">Go</button>
  </div>

  <div id="app" style="display:none;">
    <section id="home" class="active"></section>
    <section id="upload">
      <h3>Upload Video</h3>
      <input id="chName" placeholder="Channel Name"/><br/>
      <button id="uploadBtn">‚¨Ü Upload via Cloudinary</button>
    </section>
    <section id="profile"><h3>Your Profile</h3><div id="meInfo"></div><div id="profVideos"></div></section>
    <section id="withdraw">
      <h3>Withdraw</h3>
      <p><strong>Balance:</strong> ‚Çπ<span id="balAmt">0</span></p>
      <input id="wName" placeholder="Name"/><br/>
      <input id="wContact" placeholder="Email/Phone"/><br/>
      <input id="wUPI" placeholder="UPI ID"/><br/>
      <input id="wAmount" placeholder="Amount"/><br/>
      <button onclick="redeem()">Withdraw</button>
    </section>
    <nav>
      <button onclick="go('home')">üè† Home</button>
      <button onclick="go('upload')">‚¨Ü Upload</button>
      <button onclick="go('profile')">üë§ Profile</button>
      <button onclick="go('withdraw')">üí∏ Withdraw</button>
      <button onclick="logout()">üö™ Logout</button>
    </nav>
  </div>

  <script src="https://upload-widget.cloudinary.com/latest/global/all.js"></script>
  <script>
    const cloudName = "dtlbk3ncz", uploadPreset = "Inditube";
    let users = {}, sessions = {}, current = null;

    try {
      users = JSON.parse(localStorage.getItem("users") || "{}");
      sessions = JSON.parse(localStorage.getItem("sessions") || "{}");
    } catch {}

    function saveAll() {
      localStorage.setItem("users", JSON.stringify(users));
      localStorage.setItem("sessions", JSON.stringify(sessions));
    }

    function doLogin() {
      const u = uName.value.trim(), p = uPass.value.trim(), f = chImgFile.files[0];
      if (!u || !p) return alert("Enter username & password");
      if (f) {
        const r = new FileReader();
        r.onload = () => completeLogin(u, p, r.result);
        r.readAsDataURL(f);
      } else {
        completeLogin(u, p, null);
      }
    }

    function completeLogin(u, p, img) {
      if (!users[u]) users[u] = p;
      else if (users[u] !== p) return alert("Wrong password");
      current = u;
      if (!sessions[u]) sessions[u] = { channel: u, chImg: img, videos: [], wallet: 0 };
      else if (img) sessions[u].chImg = img;
      loginBox.style.display = "none";
      document.getElementById("app").style.display = "block";
      renderAll();
    }

    function logout() {
      current = null;
      location.reload();
    }

    function go(id) {
      [...document.querySelectorAll("section")].forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      if (id == "withdraw") document.getElementById("balAmt").innerText = sessions[current].wallet;
    }

    const widget = cloudinary.createUploadWidget({
      cloudName, uploadPreset, sources: ["local", "url", "camera"],
      resourceType: "video", folder: "inditube-videos", multiple: false
    }, (err, res) => {
      if (!err && res.event === "success") {
        const info = res.info;
        const v = {
          id: Date.now(), title: info.original_filename, url: info.secure_url,
          channel: sessions[current].channel, user: current,
          likes: 0, dislikes: 0, views: 0, earned: false, connected: false
        };
        sessions[current].videos.push(v); saveAll(); renderAll(); go("home");
      }
    });

    uploadBtn.onclick = () => {
      let cn = chName.value.trim();
      if (cn) sessions[current].channel = cn;
      saveAll(); widget.open();
    };

    function renderAll() {
      updateWallet(); renderHome(); renderProfile();
    }

    function updateWallet() {
      wallet.innerText = sessions[current].wallet;
    }

    function renderHome() {
      const all = Object.values(sessions).flatMap(s => s.videos);
      home.innerHTML = "<h3>Home</h3>" + all.map(v => {
        const me = sessions[v.user];
        return `
          <div class="card">
            <video id="vid${v.id}" src="${v.url}" controls></video>
            <div class="top-info">
              <img src="${me.chImg || ''}" onerror="this.style.display='none'"/>
              <strong>${v.channel}</strong>
              <span class="views">${v.views} views</span>
            </div>
            <div class="likes">
              <button onclick="like(${v.id},this)">üëç${v.likes}</button>
              <button onclick="dislike(${v.id},this)">üëé${v.dislikes}</button>
              <button class="share-btn" onclick="shareVid('${v.url}')">üîóShare</button>
              <button class="connect-btn ${v.connected?'active':''}" onclick="connect(${v.id},this)">Connect</button>
              <span class="timer" id="timer${v.id}">Watch 30s to earn ‚Çπ5</span>
            </div>
          </div>`;
      }).join('');
      all.forEach(setupTimer);
    }

    function renderProfile() {
      const me = sessions[current];
      meInfo.innerHTML = `
        <div class="top-info">
          <img src="${me.chImg || ''}" onerror="this.style.display='none'"/>
          <strong>${me.channel}</strong>
        </div>`;
      profVideos.innerHTML = me.videos.map(v => `
        <div class="card"><video src="${v.url}" controls></video>
        <div>Likes: ${v.likes} | Dislikes: ${v.dislikes} | Views: ${v.views}</div></div>
      `).join('');
    }

    function like(id, btn) {
      changeVid(id, v => v.likes++);
      btn.innerText = "üëç" + findVid(id).likes;
    }

    function dislike(id, btn) {
      changeVid(id, v => v.dislikes++);
      btn.innerText = "üëé" + findVid(id).dislikes;
    }

    function connect(id, btn) {
      changeVid(id, v => v.connected = true);
      btn.classList.add("active");
      btn.innerText = "Connected";
    }

    function shareVid(url) {
      const msg = `Watch this on IndiTubes:\n${url}`;
      if (navigator.share) navigator.share({ text: msg });
      else prompt("Copy link:", msg);
    }

    function setupTimer(v) {
      const vid = document.getElementById(`vid${v.id}`);
      const timer = document.getElementById(`timer${v.id}`);
      vid.onplay = () => {
        const earned = findVid(v.id).earned;
        if (earned) { timer.innerText = "‚úÖ Earned ‚Çπ5"; return; }
        let iv = setInterval(() => {
          const t = Math.floor(vid.currentTime);
          timer.innerText = `‚è± ${t}/30 sec`;
          if (t >= 30) {
            clearInterval(iv);
            changeVid(v.id, vi => {
              if (!vi.earned) {
                vi.earned = true; vi.views++;
                sessions[vi.user].wallet += 5;
              }
            });
            timer.innerText = "‚úÖ Earned ‚Çπ5!";
            updateWallet(); renderProfile();
          }
        }, 500);
      };
    }

    function findVid(id) {
      return Object.values(sessions).flatMap(s => s.videos).find(v => v.id === id);
    }

    function changeVid(id, fn) {
      Object.values(sessions).forEach(u => {
        u.videos = u.videos.map(v => {
          if (v.id === id) fn(v);
          return v;
        });
      });
      saveAll();
    }

    function redeem() {
      const amt = parseInt(wAmount.value),
            n = wName.value.trim(),
            c = wContact.value.trim(),
            u = wUPI.value.trim();
      if (!amt || !n || !c || !u) return alert("Fill all fields");
      if (amt > sessions[current].wallet) return alert("Insufficient");
      sessions[current].wallet -= amt; saveAll(); updateWallet();
      alert(`Your payment is processed in 2‚Äë3 hours.`);
      go("withdraw");
    }

    // PWA install
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('SW registered'))
        .catch(err => console.log('SW error:', err));
      });
    }

    if (Object.keys(users).length) document.getElementById("app").style.display = "block", renderAll();
  </script>
</body>
</html>