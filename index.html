<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IndiTube</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f9f9f9; }
    header { background: #e91e63; color: white; padding: 15px; text-align: center; font-size: 24px; position: relative; }
    #coinCounter, #earningCounter {
      position: absolute;
      font-size: 13px;
      top: 15px;
      background: #4caf50;
      padding: 5px 10px;
      border-radius: 20px;
    }
    #coinCounter { left: 15px; }
    #earningCounter { right: 15px; }

    nav { display: flex; justify-content: space-around; background: #333; padding: 10px; }
    nav a { color: white; font-weight: bold; text-decoration: none; cursor: pointer; }

    .container { padding: 20px; }
    .hidden { display: none; }

    .video-card { background: white; padding: 15px; margin-bottom: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

    .channel-info { display: flex; align-items: center; }
    .channel-img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }

    .video-controls button {
      padding: 6px 12px;
      font-size: 13px;
      font-weight: bold;
      border: none;
      cursor: pointer;
      border-radius: 50px;
      margin-right: 8px;
    }
    .like { background: #2196f3; color: white; }
    .dislike { background: #f44336; color: white; }
    .share { background: #9c27b0; color: white; }
    .connect { background: #ffeb3b; color: black; }
    .connect.connected { background: #4caf50; color: white; }

    .earn-timer { color: green; margin-top: 5px; font-size: 14px; }
    #progressBar { width: 100%; background: #ccc; border-radius: 5px; height: 20px; margin-top: 10px; }
    #progressFill { height: 100%; width: 0%; background: #4caf50; text-align: center; color: white; font-size: 12px; }

    .talkies input { width: 70%; padding: 6px; margin-top: 10px; }
    .talkies button { padding: 6px 10px; background: #2196f3; color: white; border: none; margin-left: 5px; }
  </style>
</head>
<body>
  <header>
    IndiTube
    <div id="coinCounter">Coins: 0</div>
    <div id="earningCounter">Earning: ‚Çπ0</div>
  </header>

  <nav>
    <a onclick="showPage('gallery')">Gallery</a>
    <a onclick="showPage('upload')">Upload</a>
    <a onclick="showPage('dashboard')">Dashboard</a>
    <a onclick="showPage('withdraw')">Withdraw</a>
  </nav>

  <div class="container">
    <div id="login">
      <h2>Login</h2>
      <input type="text" id="username" placeholder="Your Name" /><br /><br />
      <input type="password" id="password" placeholder="Password" /><br /><br />
      <button onclick="loginUser()">Login</button>
    </div>

    <div id="upload" class="hidden">
      <h2>Upload Video</h2>
      <input type="text" id="channelName" placeholder="Channel Name" /><br /><br />
      <input type="file" id="channelImage" /><br /><br />
      <input type="text" id="videoTitle" placeholder="Video Title" /><br /><br />
      <input type="file" id="videoFile" /><br /><br />
      <div id="progressBar"><div id="progressFill">0%</div></div><br />
      <button onclick="uploadVideo()">Upload</button>
    </div>

    <div id="gallery" class="hidden">
      <h2>Public Gallery</h2>
      <div id="video-list"></div>
    </div>

    <div id="dashboard" class="hidden">
      <h2>Your Dashboard</h2>
      <div id="dashboard-list"></div>
    </div>

    <div id="withdraw" class="hidden">
      <h2>Withdraw Earnings</h2>
      <iframe title="Withdraw Form" src="https://form.jotform.com/251825401055449" width="100%" height="600px" frameborder="0" style="border:none; overflow:auto;"></iframe>
    </div>
  </div>

  <audio id="connectSound" src="https://www.soundjay.com/button/beep-07.wav"></audio>

  <script>
    const CLOUD_NAME = "dtlbk3ncz";
    const UPLOAD_PRESET = "Inditube";
    const SCRIPT_URL = "https://api.jsonbin.io/v3/b/6864a57e8a456b7966b9d3f1"; // JSONBin link
    const JSONBIN_SECRET = "REPLACE_WITH_YOUR_SECRET_KEY";
    
    let user = null;
    let allVideos = [];
    let coins = 0;
    let earnings = 0;

    function showPage(page) {
      ["login", "upload", "gallery", "dashboard", "withdraw"].forEach(p => document.getElementById(p).classList.add("hidden"));
      document.getElementById(page).classList.remove("hidden");
      if (page === "gallery") renderVideos(allVideos, "video-list");
      if (page === "dashboard") renderVideos(allVideos.filter(v => v.user === user), "dashboard-list");
    }

    function loginUser() {
      const uname = document.getElementById("username").value;
      const pass = document.getElementById("password").value;
      if (uname && pass) {
        user = uname;
        localStorage.setItem("loggedIn", user);
        fetchVideos();
        showPage("gallery");
      } else {
        alert("Enter valid credentials");
      }
    }

    async function uploadVideo() {
      const chName = document.getElementById("channelName").value;
      const title = document.getElementById("videoTitle").value;
      const chImg = document.getElementById("channelImage").files[0];
      const vidFile = document.getElementById("videoFile").files[0];
      if (!chName || !title || !chImg || !vidFile || !user) return alert("Fill all fields");

      const imgUrl = await uploadToCloudinary(chImg, 'image');
      const vidUrl = await uploadToCloudinary(vidFile, 'video');

      const newVideo = { channel: chName, title, user, img: imgUrl, video: vidUrl };
      await saveToJsonBin(newVideo);

      allVideos.push(newVideo);
      alert("Uploaded successfully");
      showPage("gallery");
    }

    async function uploadToCloudinary(file, type) {
      const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/${type}/upload`;
      const form = new FormData();
      form.append("file", file);
      form.append("upload_preset", UPLOAD_PRESET);

      const xhr = new XMLHttpRequest();
      return new Promise((resolve, reject) => {
        xhr.open("POST", url);
        xhr.upload.onprogress = (e) => {
          const percent = Math.round((e.loaded * 100) / e.total);
          document.getElementById("progressFill").style.width = percent + "%";
          document.getElementById("progressFill").innerText = percent + "%";
        };
        xhr.onload = () => resolve(JSON.parse(xhr.responseText).secure_url);
        xhr.onerror = () => reject(xhr.statusText);
        xhr.send(form);
      });
    }

    async function saveToJsonBin(videoData) {
      await fetch(SCRIPT_URL, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "X-Master-Key": JSONBIN_SECRET
        },
        body: JSON.stringify([...allVideos, videoData])
      });
    }

    async function fetchVideos() {
      const res = await fetch(SCRIPT_URL, {
        headers: { "X-Master-Key": JSONBIN_SECRET }
      });
      const data = await res.json();
      allVideos = data.record || [];
    }

    function renderVideos(videos, containerId) {
      document.getElementById(containerId).innerHTML = videos.map((v, i) => `
        <div class="video-card">
          <div class="channel-info">
            <img src="${v.img}" class="channel-img" />
            <b>${v.channel}</b>
          </div>
          <h4>${v.title} - ‚Çπ5 Tag</h4>
          <video src="${v.video}" controls width="100%" onplay="startEarning(this, ${i})"></video>
          <div class="video-controls">
            <button class="like" onclick="increment(this)">üëç Like (<span>0</span>)</button>
            <button class="dislike" onclick="increment(this)">üëé Dislike (<span>0</span>)</button>
            <button class="share" onclick="shareVideo('${v.video}')">üîó Share</button>
            <button class="connect" onclick="connectClick(this)">‚ö° Connect (<span>0</span>)</button>
          </div>
          <div class="earn-timer" id="earn-${i}">Earnings: ‚Çπ0</div>
        </div>`).join('');
    }

    function increment(btn) {
      let span = btn.querySelector("span");
      span.innerText = parseInt(span.innerText) + 1;
    }

    function shareVideo(url) {
      navigator.clipboard.writeText(url);
      alert("Link copied!");
    }

    function connectClick(btn) {
      if (btn.classList.contains("connected")) return;
      btn.classList.add("connected");
      const audio = document.getElementById("connectSound");
      audio.play();
      let countSpan = btn.querySelector("span");
      let count = parseInt(countSpan.innerText);
      countSpan.innerText = count + 1;
    }

    function startEarning(video, index) {
      if (video.dataset.earningStarted) return;
      video.dataset.earningStarted = true;
      let sec = 0;
      const timer = setInterval(() => {
        if (video.paused || video.ended) return;
        sec++;
        if (sec % 30 === 0) {
          coins++;
          earnings += 5;
          document.getElementById("coinCounter").innerText = `Coins: ${coins}`;
          document.getElementById("earningCounter").innerText = `Earning: ‚Çπ${earnings}`;
        }
        document.getElementById(`earn-${index}`).innerText = `Earnings: ‚Çπ${(sec * 5 / 30).toFixed(2)}`;
      }, 1000);
    }

    window.onload = () => {
      const storedUser = localStorage.getItem("loggedIn");
      if (storedUser) {
        user = storedUser;
        fetchVideos().then(() => showPage("gallery"));
      } else {
        showPage("login");
      }
    };
  </script>
</body>
</html>